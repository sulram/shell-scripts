#!/bin/bash

# ===========================================
# ðŸ” Auditoria de Projeto JS/TS/Svelte
# ===========================================
# Uso: ./audit [entry-point]
# Exemplo: ./audit src/main.tsx
# ===========================================

PKG="bunx"

# Pastas a ignorar no tree
IGNORE="node_modules|.git|dist|build|.next|.nuxt|.output|.history|coverage|.cache|.turbo|.svelte-kit|.vercel|__pycache__|audit"

# -------------------------------------------
# Detecta tipo de projeto
# -------------------------------------------
detect_project_type() {
    if [ -f "svelte.config.js" ] || [ -f "svelte.config.ts" ]; then
        echo "svelte"
    else
        echo "js"
    fi
}

# -------------------------------------------
# Detecta entry point
# -------------------------------------------
detect_entry() {
    if [ -n "$1" ]; then
        echo "$1"
    elif [ -f "src/index.tsx" ]; then
        echo "src/index.tsx"
    elif [ -f "src/index.ts" ]; then
        echo "src/index.ts"
    elif [ -f "src/main.tsx" ]; then
        echo "src/main.tsx"
    elif [ -f "src/main.ts" ]; then
        echo "src/main.ts"
    elif [ -f "src/main.js" ]; then
        echo "src/main.js"
    elif [ -f "src/App.tsx" ]; then
        echo "src/App.tsx"
    elif [ -f "src/App.svelte" ]; then
        echo "src/App.svelte"
    elif [ -f "src/routes/+layout.svelte" ]; then
        echo "src/routes/+layout.svelte"
    elif [ -f "app/layout.tsx" ]; then
        echo "app/layout.tsx"
    elif [ -f "pages/_app.tsx" ]; then
        echo "pages/_app.tsx"
    else
        echo ""
    fi
}

# -------------------------------------------
# Main
# -------------------------------------------

PROJECT_TYPE=$(detect_project_type)
ENTRY=$(detect_entry "$1")

echo "ðŸ“ Projeto: $PROJECT_TYPE"
echo "ðŸ“ Entry point: ${ENTRY:-"(nÃ£o detectado)"}"
echo ""
echo "ðŸš€ Iniciando auditoria..."
echo ""

# Cria pasta
mkdir -p audit

# ðŸ“ Ãrvore
echo "ðŸ“ Gerando Ã¡rvore de arquivos..."
if command -v tree &> /dev/null; then
    tree -I "$IGNORE" --dirsfirst -a > audit/audit-tree.txt
    echo "   âœ“ audit/audit-tree.txt"
else
    echo "   âš ï¸  'tree' nÃ£o instalado"
    echo "   ðŸ’¡ brew install tree"
fi

# -------------------------------------------
# Svelte: usa svelte-check
# -------------------------------------------
if [ "$PROJECT_TYPE" = "svelte" ]; then
    
    # ðŸ” Svelte Check
    echo "ðŸ” Executando svelte-check..."
    $PKG svelte-check --output human > audit/audit-check.txt 2>&1
    
    ERROR_COUNT=$(grep -c "^Error:" audit/audit-check.txt 2>/dev/null || echo "0")
    WARN_COUNT=$(grep -c "^Warn:" audit/audit-check.txt 2>/dev/null || echo "0")
    
    if [ "$ERROR_COUNT" -gt 0 ]; then
        echo "   âš ï¸  audit/audit-check.txt ($ERROR_COUNT erros, $WARN_COUNT warnings)"
    else
        echo "   âœ“ audit/audit-check.txt ($WARN_COUNT warnings)"
    fi

# -------------------------------------------
# JS/TS: usa madge
# -------------------------------------------
else
    if [ -z "$ENTRY" ]; then
        echo "   âš ï¸  Entry point nÃ£o detectado, pulando madge..."
    else
        # ðŸ•¸ï¸ Grafo visual
        echo "ðŸ•¸ï¸  Gerando grafo visual..."
        if command -v gvpr &> /dev/null; then
            $PKG madge --image audit/audit-graph.svg "$ENTRY" 2>/dev/null
            echo "   âœ“ audit/audit-graph.svg"
        else
            echo "   âš ï¸  Graphviz nÃ£o instalado"
            echo "   ðŸ’¡ brew install graphviz"
        fi

        # ðŸ“Š JSON
        echo "ðŸ“Š Exportando dependÃªncias..."
        $PKG madge --json "$ENTRY" > audit/audit-deps.json 2>/dev/null
        echo "   âœ“ audit/audit-deps.json"

        # ðŸ”„ Circulares
        echo "ðŸ”„ Verificando circulares..."
        $PKG madge --circular "$ENTRY" > audit/audit-circular.txt 2>/dev/null
        if grep -q "â†’\|>" audit/audit-circular.txt 2>/dev/null; then
            CIRCULAR_COUNT=$(grep -c "â†’\|>" audit/audit-circular.txt 2>/dev/null || echo "?")
            echo "   âš ï¸  audit/audit-circular.txt ($CIRCULAR_COUNT encontradas)"
        else
            echo "   âœ“ audit/audit-circular.txt (nenhuma ðŸŽ‰)"
        fi

        # ðŸ‘» Ã“rfÃ£os
        echo "ðŸ‘» Buscando Ã³rfÃ£os..."
        $PKG madge --orphans "$ENTRY" > audit/audit-orphans.txt 2>/dev/null
        ORPHAN_COUNT=$(grep -c "." audit/audit-orphans.txt 2>/dev/null || echo "0")
        echo "   âœ“ audit/audit-orphans.txt ($ORPHAN_COUNT arquivos)"

        # ðŸ“ˆ Resumo
        echo "ðŸ“ˆ Gerando resumo..."
        $PKG madge --summary "$ENTRY" > audit/audit-summary.txt 2>/dev/null
        echo "   âœ“ audit/audit-summary.txt"
    fi
fi

# -------------------------------------------
# Knip (funciona pra todos)
# -------------------------------------------
echo "ðŸ”¬ Executando Knip..."
$PKG knip > audit/audit-knip.txt 2>&1

UNUSED_FILES=$(grep -c "^src/" audit/audit-knip.txt 2>/dev/null || echo "0")
UNUSED_DEPS=$(grep -c "package.json" audit/audit-knip.txt 2>/dev/null || echo "0")

echo "   âœ“ audit/audit-knip.txt ($UNUSED_FILES arquivos, $UNUSED_DEPS deps)"

# -------------------------------------------
# Resumo
# -------------------------------------------
echo ""
echo "==========================================="
echo "âœ… Auditoria completa!"
echo "==========================================="
echo ""
ls -lh audit/
echo ""

# Mostra resumo relevante
if [ "$PROJECT_TYPE" = "svelte" ]; then
    echo "ðŸ“Œ PrÃ³ximos passos:"
    echo "   1. cat audit/audit-check.txt   (erros de tipo)"
    echo "   2. cat audit/audit-knip.txt    (cÃ³digo morto)"
else
    echo "ðŸ“Œ PrÃ³ximos passos:"
    echo "   1. cat audit/audit-circular.txt  (crÃ­tico)"
    echo "   2. cat audit/audit-knip.txt      (limpeza)"
    echo "   3. open audit/audit-graph.svg    (visual)"
fi
echo ""
