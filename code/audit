#!/bin/bash

# ===========================================
# ðŸ” Auditoria de Projeto JS/TS
# ===========================================
# Uso: ./audit.sh [entry-point]
# Exemplo: ./audit.sh src/main.tsx
# ===========================================

# -------------------------------------------
# ConfiguraÃ§Ã£o
# -------------------------------------------

# Entry point (argumento ou auto-detecta)
if [ -n "$1" ]; then
    ENTRY="$1"
else
    # Auto-detecta entry points comuns
    if [ -f "src/index.tsx" ]; then
        ENTRY="src/index.tsx"
    elif [ -f "src/index.ts" ]; then
        ENTRY="src/index.ts"
    elif [ -f "src/main.tsx" ]; then
        ENTRY="src/main.tsx"
    elif [ -f "src/main.ts" ]; then
        ENTRY="src/main.ts"
    elif [ -f "src/main.js" ]; then
        ENTRY="src/main.js"
    elif [ -f "src/App.tsx" ]; then
        ENTRY="src/App.tsx"
    elif [ -f "src/App.svelte" ]; then
        ENTRY="src/App.svelte"
    elif [ -f "src/routes/+layout.svelte" ]; then
        ENTRY="src/routes/+layout.svelte"
    elif [ -f "app/layout.tsx" ]; then
        ENTRY="app/layout.tsx"
    elif [ -f "pages/_app.tsx" ]; then
        ENTRY="pages/_app.tsx"
    else
        echo "âŒ NÃ£o encontrei entry point. Use: ./audit.sh src/seu-entry.tsx"
        exit 1
    fi
fi

echo "ðŸ“ Entry point: $ENTRY"

# Detecta package manager
# if [ -f "bun.lockb" ]; then
#     PKG="bunx"
# elif [ -f "pnpm-lock.yaml" ]; then
#     PKG="pnpm dlx"
# elif [ -f "yarn.lock" ]; then
#     PKG="yarn dlx"
# else
#     PKG="npx"
# fi

PKG="bunx"

echo "ðŸ“¦ Package manager: $PKG"

# Pastas a ignorar no tree
IGNORE="node_modules|.git|dist|build|.next|.nuxt|.output|.history|coverage|.cache|.turbo|.svelte-kit|.vercel|__pycache__"

# -------------------------------------------
# ExecuÃ§Ã£o
# -------------------------------------------

echo ""
echo "ðŸš€ Iniciando auditoria..."
echo ""

# Cria pasta
mkdir -p audit

# ðŸ“ Ãrvore
echo "ðŸ“ Gerando Ã¡rvore de arquivos..."
if command -v tree &> /dev/null; then
    tree -I "$IGNORE" --dirsfirst -a > audit/audit-tree.txt
    echo "   âœ“ audit/audit-tree.txt"
else
    echo "   âš ï¸  'tree' nÃ£o instalado. Pulando..."
    echo "   ðŸ’¡ Instale com: brew install tree (mac) ou apt install tree (linux)"
fi

# ðŸ•¸ï¸ Grafo visual
echo "ðŸ•¸ï¸  Gerando grafo visual..."
if command -v gvpr &> /dev/null; then
    $PKG madge --image audit/audit-graph.svg "$ENTRY" 2>/dev/null
    echo "   âœ“ audit/audit-graph.svg"
else
    echo "   âš ï¸  Graphviz nÃ£o instalado. Pulando grafo visual..."
    echo "   ðŸ’¡ Instale com: brew install graphviz (mac) ou apt install graphviz (linux)"
fi

# ðŸ“Š JSON
echo "ðŸ“Š Exportando dependÃªncias em JSON..."
$PKG madge --json "$ENTRY" > audit/audit-deps.json 2>/dev/null
echo "   âœ“ audit/audit-deps.json"

# ðŸ”„ Circulares
echo "ðŸ”„ Verificando dependÃªncias circulares..."
$PKG madge --circular "$ENTRY" > audit/audit-circular.txt 2>/dev/null
if [ -s audit/audit-circular.txt ]; then
    CIRCULAR_COUNT=$(grep -c "â†’\|>" audit/audit-circular.txt 2>/dev/null || echo "?")
    echo "   âš ï¸  audit/audit-circular.txt ($CIRCULAR_COUNT encontradas)"
else
    echo "   âœ“ audit/audit-circular.txt (nenhuma ðŸŽ‰)"
fi

# ðŸ‘» Ã“rfÃ£os
echo "ðŸ‘» Buscando arquivos Ã³rfÃ£os..."
$PKG madge --orphans "$ENTRY" > audit/audit-orphans.txt 2>/dev/null
ORPHAN_COUNT=$(wc -l < audit/audit-orphans.txt 2>/dev/null | tr -d ' ')
echo "   âœ“ audit/audit-orphans.txt ($ORPHAN_COUNT arquivos)"

# ðŸ“ˆ Resumo
echo "ðŸ“ˆ Gerando resumo..."
$PKG madge --summary "$ENTRY" > audit/audit-summary.txt 2>/dev/null
echo "   âœ“ audit/audit-summary.txt"

# ðŸ”¬ Knip
echo "ðŸ”¬ Executando Knip (pode demorar)..."
$PKG knip > audit/audit-knip.txt 2>&1
echo "   âœ“ audit/audit-knip.txt"

# -------------------------------------------
# Resumo
# -------------------------------------------
echo ""
echo "==========================================="
echo "âœ… Auditoria completa!"
echo "==========================================="
echo ""
ls -lah audit/
echo ""
cat audit/audit-summary.txt 2>/dev/null
echo ""
echo "ðŸ“Œ PrÃ³ximos passos:"
echo "   1. cat audit/audit-circular.txt  (crÃ­tico)"
echo "   2. cat audit/audit-knip.txt      (limpeza)"
echo "   3. open audit/audit-graph.svg    (visual)"
echo ""