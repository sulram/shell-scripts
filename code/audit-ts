#!/bin/bash

# ===========================================
# ðŸ” JS/TS/React Project Audit
# ===========================================
# Usage: ./audit-ts [entry-point]
# Example: ./audit-ts src/main.tsx
# ===========================================

PKG="bunx"

# Folders to ignore in tree
IGNORE="node_modules|.git|dist|build|.next|.nuxt|.output|.history|coverage|.cache|.turbo|.svelte-kit|.vercel|__pycache__|audit"

# -------------------------------------------
# Detect entry point
# -------------------------------------------
detect_entry() {
    if [ -n "$1" ]; then
        echo "$1"
    elif [ -f "src/index.tsx" ]; then
        echo "src/index.tsx"
    elif [ -f "src/index.ts" ]; then
        echo "src/index.ts"
    elif [ -f "src/main.tsx" ]; then
        echo "src/main.tsx"
    elif [ -f "src/main.ts" ]; then
        echo "src/main.ts"
    elif [ -f "src/main.js" ]; then
        echo "src/main.js"
    elif [ -f "src/App.tsx" ]; then
        echo "src/App.tsx"
    elif [ -f "app/layout.tsx" ]; then
        echo "app/layout.tsx"
    elif [ -f "pages/_app.tsx" ]; then
        echo "pages/_app.tsx"
    else
        echo ""
    fi
}

# -------------------------------------------
# Main
# -------------------------------------------

ENTRY=$(detect_entry "$1")

echo "ðŸ“ Project: JS/TS/React"
echo "ðŸ“ Entry point: ${ENTRY:-"(not detected)"}"
echo ""
echo "ðŸš€ Starting audit..."
echo ""

# Create folder
mkdir -p audit

# ðŸ“ Tree
echo "ðŸ“ Generating file tree..."
if command -v tree &> /dev/null; then
    tree -I "$IGNORE" --dirsfirst -a > audit/audit-tree.txt
    echo "   âœ“ audit/audit-tree.txt"
else
    echo "   âš ï¸  'tree' not installed"
    echo "   ðŸ’¡ brew install tree"
fi

if [ -z "$ENTRY" ]; then
    echo "   âš ï¸  Entry point not detected, skipping madge..."
else
    # ðŸ•¸ï¸ Visual graph
    echo "ðŸ•¸ï¸  Generating visual graph..."
    if command -v gvpr &> /dev/null; then
        $PKG madge --image audit/audit-graph.svg "$ENTRY" 2>/dev/null
        echo "   âœ“ audit/audit-graph.svg"
    else
        echo "   âš ï¸  Graphviz not installed"
        echo "   ðŸ’¡ brew install graphviz"
    fi

    # ðŸ“Š JSON
    echo "ðŸ“Š Exporting dependencies..."
    $PKG madge --json "$ENTRY" > audit/audit-deps.json 2>/dev/null
    echo "   âœ“ audit/audit-deps.json"

    # ðŸ”„ Circular
    echo "ðŸ”„ Checking circular dependencies..."
    $PKG madge --circular "$ENTRY" > audit/audit-circular.txt 2>/dev/null
    if grep -q "â†’\|>" audit/audit-circular.txt 2>/dev/null; then
        CIRCULAR_COUNT=$(grep -c "â†’\|>" audit/audit-circular.txt 2>/dev/null || echo "?")
        echo "   âš ï¸  audit/audit-circular.txt ($CIRCULAR_COUNT found)"
    else
        echo "   âœ“ audit/audit-circular.txt (none ðŸŽ‰)"
    fi

    # ðŸ‘» Orphans
    echo "ðŸ‘» Finding orphans..."
    $PKG madge --orphans "$ENTRY" > audit/audit-orphans.txt 2>/dev/null
    ORPHAN_COUNT=$(grep -c "." audit/audit-orphans.txt 2>/dev/null || echo "0")
    echo "   âœ“ audit/audit-orphans.txt ($ORPHAN_COUNT files)"

    # ðŸ“ˆ Summary
    echo "ðŸ“ˆ Generating summary..."
    $PKG madge --summary "$ENTRY" > audit/audit-summary.txt 2>/dev/null
    echo "   âœ“ audit/audit-summary.txt"
fi

# -------------------------------------------
# Knip (works for all)
# -------------------------------------------
echo "ðŸ”¬ Running Knip..."
$PKG knip > audit/audit-knip.txt 2>&1

UNUSED_FILES=$(grep -c "^src/" audit/audit-knip.txt 2>/dev/null || echo "0")
UNUSED_DEPS=$(grep -c "package.json" audit/audit-knip.txt 2>/dev/null || echo "0")

echo "   âœ“ audit/audit-knip.txt ($UNUSED_FILES files, $UNUSED_DEPS deps)"

# -------------------------------------------
# Summary
# -------------------------------------------
echo ""
echo "==========================================="
echo "âœ… Audit complete!"
echo "==========================================="
echo ""
ls -lh audit/
echo ""

echo "ðŸ“Œ Next steps:"
echo "   1. cat audit/audit-circular.txt  (critical)"
echo "   2. cat audit/audit-knip.txt      (cleanup)"
echo "   3. open audit/audit-graph.svg    (visual)"
echo ""
