#!/bin/bash

# ===========================================
# ðŸ” Svelte/SvelteKit Project Audit
# ===========================================
# Usage: ./audit-svelte
# ===========================================

PKG="bunx"

# Folders to ignore in tree
IGNORE="node_modules|.git|dist|build|.next|.nuxt|.output|.history|coverage|.cache|.turbo|.svelte-kit|.vercel|__pycache__|audit"

echo "ðŸ“ Project: Svelte/SvelteKit"
echo ""

# ===========================================
# Setup: Check and install dependencies
# ===========================================

# Prefer local installation if package.json exists
if [ -f package.json ]; then
    # Check if dependencies are in package.json
    if ! grep -q '"dependency-cruiser"' package.json 2>/dev/null; then
        echo "ðŸ“¦ Installing dependency-cruiser locally..."
        bun add -d dependency-cruiser
    fi
    if ! grep -q '"knip"' package.json 2>/dev/null; then
        echo "ðŸ“¦ Installing knip locally..."
        bun add -d knip
    fi
else
    # No package.json - install globally
    if ! command -v depcruise &> /dev/null; then
        echo "ðŸŒ Installing dependency-cruiser globally..."
        bun install -g dependency-cruiser
    fi
    if ! command -v knip &> /dev/null; then
        echo "ðŸŒ Installing knip globally..."
        bun install -g knip
    fi
fi

# Create dependency-cruiser config if it doesn't exist
if [ ! -f .dependency-cruiser.cjs ] && [ ! -f .dependency-cruiser.js ]; then
    echo "ðŸ“ Creating .dependency-cruiser.cjs..."
    cat > .dependency-cruiser.cjs << 'EOF'
/** @type {import('dependency-cruiser').IConfiguration} */
module.exports = {
  forbidden: [],
  options: {
    doNotFollow: {
      path: 'node_modules',
    },
    // Exclude .svelte files to avoid Svelte 5 parsing errors
    exclude: {
      path: '\\.svelte$',
    },
    tsPreCompilationDeps: true,
    tsConfig: {
      fileName: './tsconfig.json',
    },
    enhancedResolveOptions: {
      exportsFields: ['exports'],
      conditionNames: ['import', 'require', 'node', 'default', 'types'],
      mainFields: ['module', 'main', 'types', 'typings'],
    },
    reporterOptions: {
      dot: {
        collapsePattern: 'node_modules/(@[^/]+/[^/]+|[^/]+)',
      },
    },
  },
};
EOF
    echo "   âœ“ .dependency-cruiser.cjs created"
fi

echo ""
echo "ðŸš€ Starting audit..."
echo ""

# Create folder
mkdir -p audit

# ðŸ“ Tree
echo "ðŸ“ Generating file tree..."
if command -v tree &> /dev/null; then
    tree -I "$IGNORE" --dirsfirst -a > audit/audit-tree.txt
    echo "   âœ“ audit/audit-tree.txt"
else
    echo "   âš ï¸  'tree' not installed"
    echo "   ðŸ’¡ brew install tree"
fi

# ðŸ” Svelte Check
echo "ðŸ” Running svelte-check..."
$PKG svelte-check --output human > audit/audit-check.txt 2>&1

ERROR_COUNT=$(grep -c "^Error:" audit/audit-check.txt 2>/dev/null || echo "0")
WARN_COUNT=$(grep -c "^Warn:" audit/audit-check.txt 2>/dev/null || echo "0")

if [ "$ERROR_COUNT" -gt 0 ]; then
    echo "   âš ï¸  audit/audit-check.txt ($ERROR_COUNT errors, $WARN_COUNT warnings)"
else
    echo "   âœ“ audit/audit-check.txt ($WARN_COUNT warnings)"
fi

# ðŸ•¸ï¸ Dependency Cruiser (Graph + Circular)
echo "ðŸ•¸ï¸  Generating dependency graph (depcruiser)..."
if command -v dot &> /dev/null; then
    $PKG depcruise src --include-only "^src" --output-type dot 2>/dev/null | dot -T svg > audit/audit-depcruiser-graph.svg 2>/dev/null
    echo "   âœ“ audit-depcruiser-graph.svg (TS/JS only)"
else
    echo "   âš ï¸  Graphviz not installed"
    echo "   ðŸ’¡ brew install graphviz"
fi

# ðŸ”„ Circular
echo "ðŸ”„ Checking circular dependencies (depcruiser)..."
$PKG depcruise src --include-only "^src" --output-type err > audit/audit-depcruiser-circular.txt 2>&1

if grep -q "circular" audit/audit-depcruiser-circular.txt 2>/dev/null; then
    CIRCULAR_COUNT=$(grep -c "circular" audit/audit-depcruiser-circular.txt 2>/dev/null || echo "?")
    echo "   âš ï¸  audit-depcruiser-circular.txt ($CIRCULAR_COUNT found)"
else
    echo "   âœ“ audit-depcruiser-circular.txt (none ðŸŽ‰)"
fi

# ðŸ“Š JSON
echo "ðŸ“Š Exporting dependencies (depcruiser)..."
$PKG depcruise src --include-only "^src" --output-type json > audit/audit-depcruiser-deps.json 2>/dev/null
echo "   âœ“ audit-depcruiser-deps.json"

# ===========================================
# Madge: Analysis INCLUDING .svelte files
# ===========================================

# ðŸŽ¨ Madge Graph (with Svelte)
echo "ðŸŽ¨ Generating full graph (madge)..."
if command -v dot &> /dev/null; then
    $PKG madge --extensions ts,js,svelte src/ --image audit/audit-madge-graph.svg 2>/dev/null
    echo "   âœ“ audit-madge-graph.svg (with .svelte)"
else
    echo "   âš ï¸  Graphviz not installed"
    echo "   ðŸ’¡ brew install graphviz"
fi

# ðŸ”„ Madge Circular (with Svelte)
echo "ðŸ”„ Checking circular (madge)..."
$PKG madge --extensions ts,js,svelte --circular src/ > audit/audit-madge-circular.txt 2>&1

if grep -q "Found.*circular" audit/audit-madge-circular.txt 2>/dev/null; then
    CIRCULAR_FULL=$(grep -oP "Found \K\d+" audit/audit-madge-circular.txt 2>/dev/null || echo "?")
    echo "   âš ï¸  audit-madge-circular.txt ($CIRCULAR_FULL found)"
else
    echo "   âœ“ audit-madge-circular.txt (none ðŸŽ‰)"
fi

# ðŸ“ˆ Madge Summary (with Svelte)
echo "ðŸ“ˆ Generating summary (madge)..."
$PKG madge --extensions ts,js,svelte --summary src/ > audit/audit-madge-summary.txt 2>&1
echo "   âœ“ audit-madge-summary.txt"

# ðŸ”¬ Knip
echo "ðŸ”¬ Running Knip..."
$PKG knip > audit/audit-knip.txt 2>&1

UNUSED_FILES=$(grep -c "^src/" audit/audit-knip.txt 2>/dev/null || echo "0")
UNUSED_DEPS=$(grep -c "package.json" audit/audit-knip.txt 2>/dev/null || echo "0")

echo "   âœ“ audit/audit-knip.txt ($UNUSED_FILES files, $UNUSED_DEPS deps)"

# -------------------------------------------
# Summary
# -------------------------------------------
echo ""
echo "==========================================="
echo "âœ… Audit complete!"
echo "==========================================="
echo ""
ls -lh audit/
echo ""

echo "ðŸ“Œ Next steps:"
echo "   1. cat audit/audit-check.txt                (type errors)"
echo "   2. cat audit/audit-depcruiser-circular.txt  (circular: TS/JS only)"
echo "   3. cat audit/audit-madge-circular.txt       (circular: with .svelte)"
echo "   4. cat audit/audit-madge-summary.txt        (statistics)"
echo "   5. cat audit/audit-knip.txt                 (dead code)"
echo "   6. open audit/audit-depcruiser-graph.svg    (graph: TS/JS only)"
echo "   7. open audit/audit-madge-graph.svg         (graph: with .svelte)"
echo ""
